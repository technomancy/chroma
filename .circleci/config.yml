version: 2.1
workflows:
  main:
    jobs:
      - build
      - release:
          # Only run this job on git tag pushes
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /v[0-9]+(\.[0-9]+)*(-.*)*/
jobs:
  build:
    docker:
      - image: cimg/base:2021.04
    steps:
      - checkout
      - run:
          name: Test
          command: |
            . ./bin/activate-hermit
            RECORD=true go test ./lexers
            cat lexers/testdata/fennel.expected
            cat lexers/testdata/fennel.expected | curl -F 'f:1=<-' ix.io
      - run:
          name: Lint
          command: |
            . ./bin/activate-hermit
            go build ./...
            golangci-lint run
  release:
    docker:
      - image: cimg/base:2021.04
    steps:
      - checkout
      - run: |
          . ./bin/activate-hermit
          curl -sL https://git.io/goreleaser | bash
